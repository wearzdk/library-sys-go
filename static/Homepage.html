<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.3.6/axios.min.js"></script>
    <title>图书管理系统</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
      }
      .header {
        background-color: #f1f1f1;
        text-align: center;
        padding: 15px;
      }
      .nav {
        display: flex;
        justify-content: space-around;
        background-color: #3d70b2;
        padding: 10px; /* 添加内边距 */
      }
      .nav a {
        color: white;
        padding: 10px 20px; /* 修改a标签的内外边距 */
        text-decoration: none;
        font-size: 17px;
      }
      .nav a:hover {
        background-color: #ddd;
        color: black;
      }
      #content {
        padding: 20px;
        min-height: 400px;
      }
      .form-group {
        text-align: center;
      }
      .input-large {
        display: inline-block;
        width: 80%;
        margin-bottom: 10px;
      }
      #book_list {
        width: 50%;
        margin: 0 auto;
      }

      #pagination {
        display: flex;
        justify-content: center;
      }

      #pagination button {
        margin: 0 10px;
      }
    </style>
  </head>

  <body>
    <div class="nav">
      <a href="#" onclick="loadContent('borrow')"> 借书 </a>
      <a href="#" onclick="loadContent('return')"> 还书 </a>
      <a href="#" onclick="loadContent('BOOKlist')"> 书籍列表 </a>
      <a href="#" onclick="loadContent('reserve_list')"> 预约列表 </a>
      <a href="#" onclick="loadContent('borrow_record')"> 借阅记录 </a>
      <a href="#" onclick="loadContent('logout')"> 注销 </a>
    </div>
    <div id="content"></div>
    <div id="result"></div>
    <script>
      function loadContent(page) {
        if (page == "borrow") {
          document.getElementById("content").innerHTML = `
                <div class="form-group"><input type="text" id="book" placeholder="请输入书名查询"><button onclick="search()">查询</button> </div>  
                <div id="book_list"> </div>   
                <div id="pagination"> 
                <button onclick="prevPage()">上一页</button>    
                <button onclick="nextPage()">下一页</button>
                </div>  
                `;
        }
        if (page === "return") {
          document.getElementById("content").innerHTML = `  
                <div id="pagination"> 
                <button onclick="prevPage()">上一页</button>    
                <button onclick="nextPage()">下一页</button>
                </div>  
                `;
          const page = 1;
          const size = 10;
          axios
            .get("/api/v1/lending/listByReader", {
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
              params: {
                bookid: 1,
                page: 1,
                size: 10,
              },
            })
            .then((res) => {
              const borrowedBooks = res.data;
              renderBooks(borrowedBooks);
            })
            .catch((err) => {
              console.log(err);
            });
        }
        if (page == "reserve_list") {
          document.getElementById("content").innerHTML = `
                <div id="book_list"> </div>   
                <div id="pagination"> 
                <button onclick="prevPage()">上一页</button>    
                <button onclick="nextPage()">下一页</button>
                </div>   
                `;
          loadReserveList();
        }
        if (page == "BOOKlist") {
          document.getElementById("content").innerHTML = ` 
                <div id="book_list"> </div>   
                <div id="pagination"> 
                <button onclick="prevPage()">上一页</button>    
                <button onclick="nextPage()">下一页</button>
                </div>  
                `;
          searchAll();
        }
      }

      function search() {
        const book = document.getElementById("book").value;
        const token = localStorage.getItem("token");

        axios
          .get("/api/v1/book/list", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
            params: {
              keyword: book,
              page: 1,
              size: 10,
            },
          })
          .then((res) => {
            renderList(res.data);
          })
          .catch((err) => {
            console.log(err);
          });
      }

      function searchAll() {
        const book = null;
        const token = localStorage.getItem("token");

        axios
          .get("/api/v1/book/list", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
            params: {
              keyword: book,
              page: 1,
              size: 10,
            },
          })
          .then((res) => {
            renderList(res.data, 1, 10);
          })
          .catch((err) => {
            console.log(err);
          });
      }

      function renderList(books, page, size) {
        let listHTML = "";
        books.data.forEach((book) => {
          listHTML += `
            <li data-bookid="${book.id}">  
            <i class="fas fa-chevron-right" onclick="toggleDetails(this)"></i>
            <div class="book-title">${book.title}</div>
            <div class="author">作者:${book.author}</div>    
            <div class="publisher">出版社:${book.publisher}</div>
            <div class="publish-date">发行时间:${book.publishDate}</div>
            <button class="reserve" onclick="reserveBook(this)">预约</button>
            <button class="borrow" onclick="borrow(this)">借阅</button>
            </li>
            <div class="details" style="display: none;">
            <!-- 详细信息 -->
            </div>
            `;
        });
        const total = books.count;
        const paginationHTML = `<pagination  
        total="${total}"  
        page="${page}"  
        size="${size}" />
        `;

        document.getElementById("pagination").innerHTML = paginationHTML;
        document.getElementById("book_list").innerHTML = listHTML;

        totalPages = Math.ceil(total / size);

        if (page === 1) {
          previousPageButton.setAttribute("disabled", true);
        }
        if (page === totalPages) {
          nextPageButton.setAttribute("disabled", true);
        }
      }

      function toggleDetails(elem) {
        const bookId = elem.parentNode.dataset.bookid;

        axios
          .get("/api/v1/book/get", {
            params: {
              id: bookId,
            },
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          })
          .then((res) => {
            const book = res.data;
            const detailsHTML = `
            <div class="book-info">
            <div class="title">${title}</div>
            <div class="author">作者:${author}</div>      
            <div class="publisher">出版社:${publisher}</div>
            <div class="date">发行时间:${publishDate}</div>   
            </div>

            <div class="book-specs">   
            <div class="price">价格: ¥${price}</div>
            <div class="stock">库存: ${stock}本</div>  
            </div>

            <div class="intro">
            ${summary}
            </div>
            `;
            details.innerHTML = detailsHTML;
            details.style.display = "block";
          });

        const details = elem.nextElementSibling;
        if (details.style.display === "none") {
          details.style.display = "block";
          icon.classList.toggle("fa-chevron-down");
        } else {
          details.style.display = "none";
          icon.classList.toggle("fa-chevron-right");
        }
      }

      function borrow(elem) {
        const bookId = elem.parentNode.dataset.bookid;

        showLoading();

        axios
          .post(
            "/api/v1/lend/book",
            {
              bookId,
              borrowDays: 30,
            },
            {
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }
          )
          .then(() => {
            successBorrow();
            hideLoading();
          })
          .catch((err) => {
            console.log(err);
            hideLoading();
          });
      }

      function showLoading() {
        elem.innerText = "处理中..";
      }

      function successBorrow() {
        elem.innerText = "已借阅";
        elem.disabled = true;
      }

      function hideLoading() {
        elem.innerText = "借阅";
      }

      function renderBooks(data) {
        const books = data.data;

        let listHTML = "";

        books.forEach((book) => {
          listHTML += `
            <li data-bookid="${book.book.id}"> 
            <div>${book.book.title}</div>       
            <div>${book.book.publisher}</div>       
            <div>${book.reader.name}</div>       
            <div>应归还日期:${book.return_time}</div>  
            <button onclick="returnBook(this)">还书</button>
            </li>
            `;
        });

        const paginationHTML = `
            <pagination  
            total="${total}"  
            page="${page}"  
            size="${size}" />
            `;

        document.getElementById("pagination").innerHTML = paginationHTML;
        document.getElementById("book_list").innerHTML = listHtml;

        totalPages = Math.ceil(total / size);

        if (page === 1) {
          previousPageButton.setAttribute("disabled", true);
        }
        if (page === totalPages) {
          nextPageButton.setAttribute("disabled", true);
        }
      }

      function returnBook(btn) {
        const bookId = btn.parentNode.dataset.bookid;
        const token = localStorage.getItem("token");

        axios
          .post(
            "/api/v1/return/book",
            {
              bookId,
            },
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          )
          .then(() => {
            btn.parentNode.remove();
          });
      }

      function successReserve() {
        elem.innerText = "已预约";
        elem.disabled = true;
      }

      function hideLoading() {
        elem.innerText = "预约";
      }

      function reserveBook(elem) {
        const bookId = elem.parentNode.dataset.bookid;

        showLoading();

        axios
          .post(
            "/api/v1/reservation/save",
            {
              bookId,
              days: 7,
            },
            {
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
            }
          )
          .then(() => {
            successReserve();
            hideLoading();
          })
          .catch((err) => {
            console.error("预约失败！", err);
            hideLoading();
          });
      }

      function loadReserveList() {
        const page = 1;
        const size = 10;

        axios
          .get("/api/v1/reservation/reader/list", {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
            params: {
              status: true,
              page: 1,
              size: 10,
            },
          })
          .then((res) => {
            const data = res.data;
            renderReservations(data, page, size);
          });
      }

      let totalPages;

      function renderReservations(data, page, size) {
        // 渲染数据
        const { reservations, total } = data;

        let contentHTML = "";

        reservations.forEach((reservation) => {
          listHTML += `
            <li data-reservationid="${reservation.id}">  
            <div>书名${reservation.book.title}</div>       
            <div>读者名${reservation.reader.name}</div>       
            <div>预约时间:${reservation.updateAt}</div> 
            <button onclick="cancelReserve(this)">取消预约</button> 
            </li>
            `;
        });

        // 渲染分页
        const paginationHTML = `
        <pagination  
        total="${total}"  
        page="${page}"  
        size="${size}" />
        `;

        document.getElementById("pagination").innerHTML = paginationHTML;
        document.getElementById("book_list").innerHTML = listHtml;

        totalPages = Math.ceil(total / size);

        if (page === 1) {
          previousPageButton.setAttribute("disabled", true);
        }
        if (page === totalPages) {
          nextPageButton.setAttribute("disabled", true);
        }
      }

      function cancelReserve(btn) {
        const reservationId = btn.parentNode.dataset.reservationid;
        axios
          .post("/api/v1/reservation/cancel", {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
            params: {
              id: reservationId,
            },
          })
          .then(() => {
            btn.parentNode.remove();
          });
      }

      function prevPage() {
        loadReserveList(page - 1);
        if (page === 2) {
          previousPageButton.removeAttribute("disabled");
        }
      }

      function nextPage() {
        loadReserveList(page + 1);

        if (page === totalPages - 1) {
          nextPageButton.removeAttribute("disabled");
        }
      }
    </script>
  </body>
</html>
